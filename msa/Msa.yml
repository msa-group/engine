Composer:
  
  Backend:
    Component: fc3
    Properties:
      Function:
        CustomContainerConfig:
          Fn::Sub:
            - '{"Port": 80,"Image":"registry.${Region}.aliyuncs.com/oss-share/msa:httpbin", "RegistryConfig":{"CertConfig":{"Insecure":false}}}'
            - Region: {{Parameters.Region}}
    Parameters:
      Name: {{Subfix(Parameters.Name)}}
  Service:
    DependsOn: Backend
    Component: apig.service
    Parameters:
      Port: 80
      AddressesName: {{RosOutputHostName(Backend.HttpTrigger, "UrlIntranet")}}
      Name: {{Subfix(Join([Parameters.Name, '-','svc']))}}

  HttpApi:
    DependsOn:
      - Service
    Component: apig.http.api 
    Parameters:
      ApiName: {{Subfix(Join([Parameters.Name, '-','http']))}}
      Routes:
        - Operation:
            Name: {{Parameters.Name}}
            Path: 'Prefix /'
            Scene: SingleService
            Services:
              - ServiceId: {{RosOutput(Service, "ServiceId")}}
                Protocol: HTTP
                Weight: 100
          PolicyClassName: "HttpRewrite"
          PolicyConfig:
            Fn::Sub:
              - '{"pathType":"Prefix","host":"${HOST}","enable":true}'
              - HOST: {{RosOutputHostName(Backend.HttpTrigger, "UrlIntranet")}}
  KeyAuthPlugin:
    DependsOn: HttpApi
    Component: apig.router.plugin
    Parameters:
      PluginClassId: pls-cqebrgh4ckt6ppatmprx
      RouteIds:
        - {{RosOutput(HttpApi, "RouteId")}}
      PluginConfig: |
        consumers:
        - credential: 2bda943c-ba2b-11ec-ba07-00163e1250b5
          name: consumer1
        keys:
        - x-api-key